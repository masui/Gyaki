// Generated by CoffeeScript 1.7.1
var app, browserHeight, browserWidth, initCallbacks, initElements, initParams, resize;

app = {};

browserWidth = function() {
  if (window.innerWidth) {
    return window.innerWidth;
  }
  if (document.body) {
    return document.body.clientWidth;
  }
  return 0;
};

browserHeight = function() {
  if (window.innerHeight) {
    return window.innerHeight;
  }
  if (document.body) {
    return document.body.clientHeight;
  }
  return 0;
};

resize = function() {
  var buttonHeight, buttonWidth, canvasSize, gap, i, img, orientation, tmp, _i, _j, _results, _results1;
  window.devicePixelRatio = 1.0;
  app.width = browserWidth();
  app.height = browserHeight();
  canvasSize = app.height < app.width ? app.height : app.width;
  if (gyazoImageID) {
    img = new Image();
    img.src = "/gyazodata/" + gyazoImageID;
    img.onload = function() {
      return app.context.drawImage(img, 0, 0);
    };
  }
  orientation = 'portrait';
  if (window.orientation) {
    if (window.orientation === '0' || window.orientation === '180') {
      orientation = 'portrait';
    } else {
      orientation = 'landscape';
      tmp = app.width;
      app.width = app.height;
      app.height = tmp;
    }
  } else {
    orientation = app.width > app.height ? 'landscape' : 'portraie';
  }
  app.canvas.attr('width', canvasSize).attr('height', canvasSize);
  app.context.fillStyle = '#FFF';
  app.context.fillRect(0, 0, app.width, app.height);
  if (orientation === 'portrait') {
    buttonWidth = app.width / 10;
    buttonHeight = buttonWidth;
    gap = (app.width - (buttonWidth * 7)) / 11;
    app.uploadButton.css('top', app.width + gap).css('left', gap).css('width', buttonWidth).css('height', nbuttonHeight).css('visibility', 'visible');
    _results = [];
    for (i = _i = 0; _i < 3; i = ++_i) {
      app.lineButton[i].css('top', app.width + gap).css('left', gap * 3 + buttonWidth + (buttonWidth + gap) * i).css('width', buttonWidth).css('height', buttonWidth).css('visibility', 'visible');
      _results.push(app.colorButton[i].css('top', app.width + gap).css('left', gap * 7 + buttonWidth * 4 + (buttonWidth + gap) * i).css('width', buttonWidth).css('height', buttonWidth).css('visibility', 'visible'));
    }
    return _results;
  } else {
    buttonHeight = app.height / 10;
    buttonWidth = buttonHeight;
    gap = (app.height - (buttonHeight * 7)) / 11;
    app.uploadButton.css('top', gap).css('left', canvasSize + gap).css('width', buttonWidth).css('height', buttonHeight).css('visibility', 'visible');
    _results1 = [];
    for (i = _j = 0; _j < 3; i = ++_j) {
      app.lineButton[i].css('top', gap * 3 + buttonWidth + (buttonWidth + gap) * i).css('left', canvasSize + gap).css('width', buttonWidth).css('height', buttonHeight).css('visibility', 'visible');
      _results1.push(app.colorButton[i].css('top', gap * 7 + buttonWidth * 4 + (buttonWidth + gap) * i).css('left', canvasSize + gap).css('width', buttonWidth).css('height', buttonHeight).css('visibility', 'visible'));
    }
    return _results1;
  }
};

initElements = function() {
  var i, _i, _results;
  app.canvas = $('<canvas>');
  $('body').append(app.canvas);
  app.uploadButton = $('<input type="button">').css('position', 'absolute').css('visibility', 'hidden').attr('value', 'UP');
  $('body').append(app.uploadButton);
  app.lineButton = [];
  app.colorButton = [];
  _results = [];
  for (i = _i = 0; _i < 3; i = ++_i) {
    app.lineButton[i] = $('<img>').css('position', 'absolute').css('visibility', 'hidden').attr('src', '/images/line' + (i + 1) + '.png');
    $('body').append(app.lineButton[i]);
    app.colorButton[i] = $('<img>').css('position', 'absolute').css('visibility', 'hidden').attr('src', '/images/color' + (i + 1) + '.png');
    _results.push($('body').append(app.colorButton[i]));
  }
  return _results;
};

initParams = function() {
  window.devicePixelRatio = 1.0;
  app.canvasX = app.canvas.offset()["left"];
  app.canvasY = app.canvas.offset()["top"];
  app.crd = {
    cur: {
      x: 0,
      y: 0
    },
    pre: {
      x: 0,
      y: 0
    }
  };
  app.drawing = false;
  app.lineWidth = 15;
  app.strokeStyle = "#000";
  app.context = app.canvas[0].getContext('2d');
  app.lineButton[0].on('click', function(e) {
    return app.lineWidth = 3;
  });
  app.lineButton[1].on('click', function(e) {
    return app.lineWidth = 15;
  });
  app.lineButton[2].on('click', function(e) {
    return app.lineWidth = 30;
  });
  app.colorButton[0].on('click', function(e) {
    return app.strokeStyle = 'rgb(255, 255, 255)';
  });
  app.colorButton[1].on('click', function(e) {
    return app.strokeStyle = 'rgb(128, 128, 128)';
  });
  return app.colorButton[2].on('click', function(e) {
    return app.strokeStyle = 'rgb(0, 0, 0)';
  });
};

initCallbacks = function() {
  app.canvas.on('touchmove mousemove', function(e) {
    var x, y;
    e.preventDefault();
    if ('touchmove' === e.type) {
      x = e.originalEvent.changedTouches[0].pageX;
      y = e.originalEvent.changedTouches[0].pageY;
    } else {
      x = e.pageX;
      y = e.pageY;
    }
    x -= app.canvasX;
    y -= app.canvasY;
    if (x === app.width / 2 && y === app.width / 2) {
      return;
    }
    if (app.drawing) {
      app.context.beginPath();
      app.context.lineJoin = "round";
      app.context.lineCap = "round";
      app.context.strokeStyle = app.strokeStyle;
      app.context.lineWidth = app.lineWidth;
      app.context.moveTo(app.crd.pre.x, app.crd.pre.y);
      app.crd.cur.x = x;
      app.crd.cur.y = y;
      app.context.lineTo(app.crd.cur.x, app.crd.cur.y);
      app.crd.pre.x = app.crd.cur.x;
      app.crd.pre.y = app.crd.cur.y;
      app.context.stroke();
      return app.context.closePath();
    } else {
      app.crd.pre.x = app.crd.cur.x;
      app.crd.pre.y = app.crd.cur.y;
      app.crd.cur.x = x;
      return app.crd.cur.y = y;
    }
  });
  app.canvas.on('touchstart mousedown', function(e) {
    var x, y;
    e.preventDefault();
    if ('touchstart' === e.type) {
      x = e.originalEvent.changedTouches[0].pageX;
      y = e.originalEvent.changedTouches[0].pageY;
    } else {
      x = e.pageX;
      y = e.pageY;
    }
    x -= app.canvasX;
    y -= app.canvasY;
    app.crd.pre.x = x;
    app.crd.pre.y = y;
    return app.drawing = true;
  });
  app.canvas.on('touchend mouseup', function(e) {
    e.preventDefault();
    return app.drawing = false;
  });
  app.uploadButton.on('click', function(e) {
    var imagedata;
    imagedata = app.canvas[0].toDataURL();
    return $.ajax({
      type: 'POST',
      url: '/upload',
      data: {
        data: imagedata,
        id: gyazoUserID
      },
      success: function(data, textStatus, jqXHR) {
        return location.href = data;
      }
    });
  });
  return $(window).on('resize', resize);
};

initElements();

initParams();

initCallbacks();

resize();
